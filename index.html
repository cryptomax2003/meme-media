<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEME MEDIA | The Future of Meme Finance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CRITICAL: JavaScript loaded in HEAD with defer -->
    <script>
        // Initialize app immediately
        window.app = {
            data: {
                currentUser: null,
                users: [],
                posts: [],
                currentTab: 'all',
                currentCategory: 'All',
                searchQuery: '',
                authMode: 'login',
                verificationCode: null,
                codeExpiry: null,
                view: 'home',
                profileViewUser: null
            },

            admins: ['cryptomax172003@gmail.com'],

            init() {
                console.log('App initializing...');
                this.loadData();
                this.setupEventListeners();
                this.render();
                console.log('App initialized successfully');
            },

            loadData() {
                console.log('Loading data...');
                if (this.data.posts.length === 0) {
                    this.data.posts = [
                        {
                            id: 1,
                            title: "PEPE Coin Breaks Resistance!",
                            content: "Technical analysis shows a clear breakout pattern. Expecting 2x in the next 24h. NFA.",
                            category: "Moonshots",
                            author: "cryptomax172003@gmail.com",
                            authorTag: "CryptoMax",
                            image: "https://images.unsplash.com/photo-1621761191319-c6fb62004040?w=800&q=80",
                            likes: 42,
                            dislikes: 2,
                            comments: [],
                            timestamp: Date.now() - 100000,
                            type: 'top',
                            likesList: [],
                            dislikesList: []
                        },
                        {
                            id: 2,
                            title: "Rug Pull Warning: DOGE2.0",
                            content: "Liquidity locked for only 1 day. Dev wallet moving funds. Stay safe out there.",
                            category: "Rug Alerts",
                            author: "user1@test.com",
                            authorTag: "Watcher",
                            image: "https://images.unsplash.com/photo-1621504450168-b8c4375443a2?w=800&q=80",
                            likes: 156,
                            dislikes: 0,
                            comments: [{user: 'anon', text: 'Thanks for the heads up!'}],
                            timestamp: Date.now() - 200000,
                            type: 'all',
                            likesList: [],
                            dislikesList: []
                        }
                    ];
                    
                    this.data.users.push({
                        email: 'cryptomax172003@gmail.com',
                        tag: 'CryptoMax',
                        pic: 'https://ui-avatars.com/api/?name=CM&background=10b981&color=fff',
                        following: [],
                        followers: [],
                        lastPostDate: null,
                        postsToday: 0
                    });
                }
                console.log('Data loaded:', this.data.posts.length, 'posts');
            },

            navigate(viewName, param = null) {
                console.log('Navigating to:', viewName);
                this.data.view = viewName;
                
                const homeView = document.getElementById('homeView');
                const createView = document.getElementById('createPostView');
                const profileView = document.getElementById('profileView');
                
                if (homeView) homeView.classList.add('hidden');
                if (createView) createView.classList.add('hidden');
                if (profileView) profileView.classList.add('hidden');

                if (viewName === 'home' && homeView) {
                    homeView.classList.remove('hidden');
                    this.renderPosts();
                } else if (viewName === 'create' && createView) {
                    createView.classList.remove('hidden');
                } else if (viewName === 'profile' && profileView) {
                    profileView.classList.remove('hidden');
                    this.renderProfile(param);
                }
                
                window.scrollTo(0,0);
            },

            switchTab(tab) {
                console.log('Switching tab to:', tab);
                this.data.currentTab = tab;
                
                const allBtn = document.getElementById('tab-all');
                const topBtn = document.getElementById('tab-top');
                const controls = document.getElementById('allNewsControls');

                if (!allBtn || !topBtn) return;

                if (tab === 'all') {
                    allBtn.classList.add('bg-green-500/10', 'text-green-400', 'border-green-500/30');
                    allBtn.classList.remove('bg-gray-900', 'text-gray-400', 'border-gray-700');
                    
                    topBtn.classList.remove('bg-pink-500/10', 'text-pink-400', 'border-pink-500/30');
                    topBtn.classList.add('bg-gray-900', 'text-gray-400', 'border-gray-700');
                    
                    if (controls) controls.classList.remove('hidden');
                } else {
                    topBtn.classList.add('bg-pink-500/10', 'text-pink-400', 'border-pink-500/30');
                    topBtn.classList.remove('bg-gray-900', 'text-gray-400', 'border-gray-700');
                    
                    allBtn.classList.remove('bg-green-500/10', 'text-green-400', 'border-green-500/30');
                    allBtn.classList.add('bg-gray-900', 'text-gray-400', 'border-gray-700');
                    
                    if (controls) controls.classList.add('hidden');
                }
                this.renderPosts();
            },

            setCategory(cat) {
                console.log('Setting category:', cat);
                this.data.currentCategory = cat;
                
                document.querySelectorAll('.category-pill').forEach(btn => {
                    const btnText = btn.innerText.replace(/[^\w\s]/g, '').trim();
                    if((cat === 'All' && btnText === 'All') || btnText === cat) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                this.renderPosts();
            },

            filterPosts() {
                const searchInput = document.getElementById('searchInput');
                this.data.searchQuery = searchInput ? searchInput.value.toLowerCase() : '';
                console.log('Filtering posts:', this.data.searchQuery);
                this.renderPosts();
            },

            renderPosts() {
                console.log('Rendering posts...');
                const container = document.getElementById('postsContainer');
                if (!container) {
                    console.error('postsContainer not found!');
                    return;
                }
                
                container.innerHTML = '';

                let filtered = this.data.posts;

                if (this.data.currentTab === 'top') {
                    filtered = filtered.filter(p => p.type === 'top' || this.admins.includes(p.author));
                }

                if (this.data.currentTab === 'all' && this.data.currentCategory !== 'All') {
                    filtered = filtered.filter(p => p.category === this.data.currentCategory);
                }

                if (this.data.searchQuery) {
                    filtered = filtered.filter(p => 
                        p.title.toLowerCase().includes(this.data.searchQuery) || 
                        p.content.toLowerCase().includes(this.data.searchQuery)
                    );
                }

                filtered.sort((a, b) => b.timestamp - a.timestamp);

                if (filtered.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-gray-500 mb-4">No posts found</div>
                            <button onclick="window.app.navigate('create')" class="bg-green-600 text-black px-6 py-2 rounded-lg font-bold hover:bg-green-500 transition-colors">
                                Create First Post
                            </button>
                        </div>
                    `;
                    return;
                }

                filtered.forEach(post => {
                    const isAdmin = this.admins.includes(post.author);
                    const isAuthor = this.data.currentUser && this.data.currentUser.email === post.author;
                    const canDelete = isAdmin || isAuthor;
                    
                    let userLikeStatus = 'none';
                    if (this.data.currentUser) {
                        if (post.likesList && post.likesList.includes(this.data.currentUser.email)) userLikeStatus = 'like';
                        if (post.dislikesList && post.dislikesList.includes(this.data.currentUser.email)) userLikeStatus = 'dislike';
                    }

                    const card = document.createElement('div');
                    card.className = 'glass-panel rounded-xl overflow-hidden border border-gray-800 hover:border-green-500/50 transition-all duration-300 flex flex-col';
                    
                    card.innerHTML = `
                        ${post.image ? `
                        <div class="h-48 overflow-hidden relative group">
                            <img src="${post.image}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" onerror="this.src='https://via.placeholder.com/800x400?text=Meme+Media'">
                            <div class="absolute top-2 right-2 bg-black/70 backdrop-blur px-2 py-1 rounded text-xs font-bold text-green-400 border border-green-500/30">
                                ${post.category}
                            </div>
                            ${post.type === 'top' || isAdmin ? `<div class="absolute top-2 left-2 bg-pink-600 text-white px-2 py-1 rounded text-xs font-bold shadow-lg shadow-pink-500/20"><i class="fa-solid fa-crown"></i> TOP</div>` : ''}
                        </div>` : ''}
                        
                        <div class="p-5 flex-grow flex flex-col">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-bold text-white leading-tight hover:text-green-400 cursor-pointer" onclick="window.app.navigate('profile', '${post.author}')">${post.title}</h3>
                            </div>
                            
                            <div class="flex items-center gap-2 mb-3 text-xs text-gray-400">
                                <span class="text-green-400 font-mono cursor-pointer hover:underline" onclick="window.app.navigate('profile', '${post.author}')">@${post.authorTag}</span>
                                <span>â€¢</span>
                                <span>${new Date(post.timestamp).toLocaleDateString()}</span>
                            </div>

                            <p class="text-gray-300 text-sm mb-4 line-clamp-3 flex-grow">${post.content}</p>
                            
                            <div class="flex items-center justify-between pt-4 border-t border-gray-800 mt-auto">
                                <div class="flex gap-4">
                                    <button onclick="window.app.handleVote(${post.id}, 'like')" class="flex items-center gap-1 text-sm ${userLikeStatus === 'like' ? 'text-green-400' : 'text-gray-500 hover:text-green-400'} transition-colors">
                                        <i class="fa-solid fa-arrow-up"></i> ${post.likes || 0}
                                    </button>
                                    <button onclick="window.app.handleVote(${post.id}, 'dislike')" class="flex items-center gap-1 text-sm ${userLikeStatus === 'dislike' ? 'text-red-400' : 'text-gray-500 hover:text-red-400'} transition-colors">
                                        <i class="fa-solid fa-arrow-down"></i> ${post.dislikes || 0}
                                    </button>
                                    <button class="flex items-center gap-1 text-sm text-gray-500 hover:text-blue-400 transition-colors">
                                        <i class="fa-solid fa-comment"></i> ${post.comments ? post.comments.length : 0}
                                    </button>
                                </div>
                                ${canDelete ? `
                                <button onclick="window.app.deletePost(${post.id})" class="text-gray-600 hover:text-red-500 transition-colors text-xs">
                                    <i class="fa-solid fa-trash"></i> Delete
                                </button>` : ''}
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            },

            handleNewPostClick() {
                console.log('New Post clicked');
                if (!this.data.currentUser) {
                    this.showToast('Please login to create a post', 'error');
                    this.toggleAuthModal();
                    return;
                }
                
                const user = this.data.users.find(u => u.email === this.data.currentUser.email);
                const today = new Date().toDateString();
                
                if (!this.admins.includes(user.email)) {
                    if (user.lastPostDate === today && user.postsToday >= 3) {
                        this.showToast('Daily post limit reached (3/3)', 'error');
                        return;
                    }
                }

                this.navigate('create');
            },

            submitPost(e) {
                e.preventDefault();
                console.log('Submitting post...');
                const form = e.target;
                const user = this.data.users.find(u => u.email === this.data.currentUser.email);
                
                const today = new Date().toDateString();
                if (!this.admins.includes(user.email)) {
                    if (user.lastPostDate === today && user.postsToday >= 3) {
                        this.showToast('Limit reached', 'error');
                        return;
                    }
                }

                const newPost = {
                    id: Date.now(),
                    title: form.title.value,
                    content: form.content.value,
                    category: form.category.value,
                    image: form.imageUrl.value,
                    author: user.email,
                    authorTag: user.tag,
                    likes: 0,
                    dislikes: 0,
                    likesList: [],
                    dislikesList: [],
                    comments: [],
                    timestamp: Date.now(),
                    type: 'all'
                };

                this.data.posts.unshift(newPost);
                
                if (user.lastPostDate !== today) {
                    user.lastPostDate = today;
                    user.postsToday = 0;
                }
                user.postsToday++;
                
                this.showToast('Post published successfully!');
                this.navigate('home');
            },

            deletePost(id) {
                if(confirm('Are you sure you want to delete this post?')) {
                    this.data.posts = this.data.posts.filter(p => p.id !== id);
                    this.renderPosts();
                    this.showToast('Post deleted');
                }
            },

            handleVote(postId, type) {
                console.log('Voting:', postId, type);
                if (!this.data.currentUser) {
                    this.showToast('Login to vote', 'error');
                    return;
                }

                const post = this.data.posts.find(p => p.id === postId);
                const userEmail = this.data.currentUser.email;

                if (!post.likesList) post.likesList = [];
                if (!post.dislikesList) post.dislikesList = [];

                const hasLiked = post.likesList.includes(userEmail);
                const hasDisliked = post.dislikesList.includes(userEmail);

                if (type === 'like') {
                    if (hasLiked) {
                        post.likesList = post.likesList.filter(e => e !== userEmail);
                        post.likes--;
                    } else {
                        post.likesList.push(userEmail);
                        post.likes++;
                        if (hasDisliked) {
                            post.dislikesList = post.dislikesList.filter(e => e !== userEmail);
                            post.dislikes--;
                        }
                    }
                } else if (type === 'dislike') {
                    if (hasDisliked) {
                        post.dislikesList = post.dislikesList.filter(e => e !== userEmail);
                        post.dislikes--;
                    } else {
                        post.dislikesList.push(userEmail);
                        post.dislikes++;
                        if (hasLiked) {
                            post.likesList = post.likesList.filter(e => e !== userEmail);
                            post.likes--;
                        }
                    }
                }
                this.renderPosts();
            },

            renderProfile(targetEmail) {
                const email = targetEmail || (this.data.currentUser ? this.data.currentUser.email : null);
                
                if (!email) {
                    this.showToast('Please login to view profiles', 'error');
                    this.navigate('home');
                    return;
                }

                const user = this.data.users.find(u => u.email === email);
                if (!user) return;

                const profileName = document.getElementById('profileName');
                const profileTag = document.getElementById('profileTag');
                const profileImage = document.getElementById('profileImage');
                const profilePostsCount = document.getElementById('profilePostsCount');
                const profileFollowers = document.getElementById('profileFollowers');
                const profileFollowing = document.getElementById('profileFollowing');
                const editSection = document.getElementById('editProfileSection');
                const followBtn = document.getElementById('followBtn');
                const userPostsContainer = document.getElementById('userPostsContainer');

                if (profileName) profileName.innerText = user.tag;
                if (profileTag) profileTag.innerText = user.email;
                if (profileImage) profileImage.src = user.pic || `https://ui-avatars.com/api/?name=${user.tag}&background=10b981
